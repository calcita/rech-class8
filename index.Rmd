---
title: "R aplicado a la ECH"
subtitle: "Setiembre 2020 <br> Gabriela Mathieu"
#`r icon::fa_r_project(colour = "#43a2ca")`
# author: "<br> `r icon::fa_creative_commons(colour = "#f0f0f0")` `r icon::fa_creative_commons_by(colour = "#f0f0f0")` `r icon::fa_creative_commons_sa(colour = "#f0f0f0")` <br> Gabriela Mathieu"
author: <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br /> <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    #css: [default, default-fonts, rladies-fonts]
    #lib_dir: libs
    nature:
       highlightStyle: github
       highlightLines: true
       countIncrementalSlides: false
       ratio: "16:9"
       slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
---
```{r, include = F}
knitr::opts_chunk$set(fig.width = 6, message = FALSE, warning = FALSE, comment = "", cache = FALSE, fig.retina = 3)
library(flipbookr)
library(tidyverse)
library(flair)
library(kableExtra)
options(scipen = 9999)
```
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo_accent(
  #base_color = "#43a2ca",
  header_font_google = google_font("Mukta"),#Ubuntu Condensed
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono"),
  primary_color      = "#0F4C81", # pantone classic blue
  secondary_color    = "#b3e2cd", # pantone baby blue
  #header_font_google = google_font("Raleway"),
  #text_font_google   = google_font("Raleway", "300", "300i"),
  #code_font_google   = google_font("Source Code Pro"),
  text_font_size     = "25px"
#   colors = c(
#   red = "#f34213",
#   purple = "#3e2f5b",
#   orange = "#ff8811",
#   green = "#136f63",
#   white = "#FFFFFF",
# )
)

```

```{r, include=FALSE}
text_spec2 <- function(x = "x"){
  text_spec(x, background = "#b3e2cd", bold = T)
}
```

```{r echo = FALSE}
library(dplyr) # cargo el paquete
load("data/ech19.RData") #importo los datos
```

# ¿Qué haremos hoy?

- Repaso
<br><br>
--

- Cálculo de ingresos a precios constantes, quintiles y deciles
<br><br>
--

- Estimación de indicadores de ingresos y distribución del ingreso

- Ejercicios

---
# Ingresos

- La medición de los ingresos tiene un  `r text_spec2("rezago de un mes")` ya que si el hogar fue encuestado, por ejemplo en marzo, en este mes se preguntó por los ingresos del mes anterior, es decir, de febrero. 
<br><br>
--

- Se relevan  `r text_spec2("ingresos personales y del hogar")`:

     Los ingresos personales se clasifican en: 
    Ingresos por trabajo: dependiente e independiente (en dinero y en especie)
    Ingresos por transferencias: incluye los ingresos provenientes de instituciones públicas o privadas (en dinero y en especie) 
    Otros ingresos personales: se incluye específicamente la devolución de Fonasa y todo otro ingreso corriente.
    
     Los ingresos del hogar se clasifican en:
    Transferencias de otros hogares (en dinero y en especie)
    Rentas de la propiedad de activos físicos y financieros.
    Ingresos por dividendos y utilidades de negocios en los que la persona no trabaja.
    Valor locativo (para los propietariosy ocupantes, en áreas urbanas)


---
# Valor locativo

- El valor locativo de la vivienda en propiedad se computa en la `r text_spec2("rezago de un mes")`variable ht13 y se imputa en la variable ht11
<br><br>
--

- Es un `r text_spec2("gasto no realizado que se imputa como ingreso")` en concepto de 'servicios de vivienda producidos por propietarios que habitan su vivienda o bien servicios de vivienda recibidos por el hogar por cesión de los propietarios'.
<br><br>
--

- Si los miembros de ese hogar desearan habitar esta vivienda, deberían incrementar su ingreso total en el valor locativo. Desde este punto de vista, `r text_spec2("un gasto no realizado que se contabiliza como ingreso")`. 
<br><br>
--

- En la ENGIH 2005-06 se relevó el valor locativo a partir de la `r text_spec2("estimación de los propios hogares, propietarios u ocupantes")`. Se les preguntó por el monto del alquiler que pagarían si arrendaran su vivienda.

<!-- - La importancia del análisis del valor locativo (VL) se debe, en primer lugar, al peso que tiene en el gasto no alimentario y en el ingreso de los hogares. Por otra parte, en el caso del Uruguay, la mayoría de los hogares son propietarios de la vivienda que ocupan, o la misma les fue cedida (el 86% de los hogares en todo el país declaran valor locativo; y sólo el 14% de los hogares alquilan la vivienda que ocupan). -->


Fuente: http://www3.ine.gub.uy:82/Anda4/index.php/catalog/42/datafile/F6/V320

---
# Ingresos a precios corrientes

- Los ingresos relevados en la ECH están `r text_spec2("expresados a precios corrientes")`. 
<br><br>
--

- Para `r text_spec2("hacerlos comparables entre los diferentes meses de la encuesta o entre años ")`es necesario llevarlos a una medida común. Vamos a `r text_spec2("pasar de precios corrientes a precios constantes")`.
<br><br>
--

- Para convertir los ingresos de precios corrientes a precios constantes debemos elegir un índice para construir un `r text_spec2("deflactor")`. Lo más común es usar el IPC (Índice de Precios al Consumo) o el IPAB (Índice de Precios de Alimentos y Bebidas). 

---
# IPC general

- Obtener los datos del IPC es bastante sencillo usando el paquete ech.

- La función `r text_spec2("get_ipc()")` que descarga el archivo de la web del INE y lo guarda en un formato tidy en el data frame ipc_base2010. La estructura del objeto es la siguiente:

```{r}
library(ech)
ipc_base2010 %>% tail()
```


---
# IPC regional

Desde 2010 el INE releva precios para todo el país y así construye un IPC para Montevideo y otro para el Interior.

.pull-left[
```{r}
ipc_base2010_int %>% tail()
```

]
.pull-right[
```{r}
ipc_base2010_mdeo %>% tail()
```

]
---
# IPAB

Otro índice de precios es el IPAB y también se obtiene fácilmente usando el paquete ech.

- ipab_base2010

- ipab_base2010mdeo

- ipab_base2010_int

---
# Variables

- El `r text_spec2("ingreso total del hogar")` con valor locativo, es el ingreso percibido por todas las personas integrantes del hogar menos el servicio doméstico.

- El `r text_spec2("ingreso per cápita del hogar")` es el cociente entre el ingreso total del hogar y la cantidad de personas que integran el hogar (sin servicio doméstico).


Descripción | Variable | Códigos
---------------------------------------------|-----------|------------
Ingreso total del hogar con valor locativo sin servicio doméstico	| ht11	| $
Valor locativo	| ht13 |	$ 
Cantidad de personas sin servicio doméstico	| ht19 |	Nº

---
class: inverse, center, middle
# ech::deflate()

---
# Deflactor

- La función `r text_spec2("deflate()")`, selecciona las filas de ipc_base2010 de diciembre del mes anterior al año de la encuesta y noviembre del año de la encuesta.

- En general, se toma como IPC base junio del año de la encuesta.

- Para calcular el deflactor de cada mes, el valor del IPC base –correspondiente a junio de 2019– es dividido por el valor del IPC de cada uno de los meses.

- Esta función `r text_spec2("opera al interior de la función income_constant_prices()")`.

---
class: inverse, center, middle
# ech::income_constant_prices()

---
# Ingresos a precios constantes

Para convertir los ingresos del hogar, que están medidos en la variable ht11, de precios corrientes a precios constantes, usamos la función income_constant_prices() y definimos sus parámetros:

```{r }
load("data/ech19.RData")
ech19 <- income_constant_prices(data = ech19,
                             base_month = 6,   # mes base
                             base_year = 2019, # año base
                             index = "IPC",    # tipo de índice
                             level = "G")      # nivel del índice G o R
```


Esto crea una serie de variables:

    y_pc: ingreso per cápita a precios corrientes
    y_pc_d: ingreso per cápita a precios constantes
    rv_d: valor locativo a precios constantes
    y_wrv_d: ingreso sin valor locativo a precios constantes
    y_wrv_pc_d: ingreso sin valor locativo per cápita a precios constantes


---
# Estimación de ingresos a precios constantes

Estimamos el ingreso promedio per cápita a pesos constantes de junio 2019.

```{r }
get_estimation_mean(ech19,
                    variable = "y_pc_d", 
                    level = "i",
                    ids = "upm",
                    estrato = "estrato")
```

---
# Estimación de ingresos a precios constantes 

Ingresos promedio per cápita a pesos constantes de junio 2019 según departamento

```{r}
get_estimation_mean(ech19,
                    variable = "y_pc_d",
                    by.x = "nomdpto",
                    level = "i",
                    ids = "upm",
                    estrato = "estrato")
```
---
class: inverse, center, middle
# ech::income_quantiles()

---
# Cuantiles de ingreso

Los cuantiles son medidas estadísticas de posición que tienen la propiedad de dividir un conjunto de datos ordenados (de forma creciente) en 'q' partes iguales. La varianza es una medida de dispersión y la media y mediana de tendencia central.

Los cuantiles de ingresos más comunes son: cuartiles, **quintiles**, **deciles** y percentiles.

```{r eval=FALSE}
income_quantiles(
  data = ech::toy_ech_2018, # microdatos
  quantile = 5,             # cuantiles, 5 para quintiles, 10 para deciles
  weights = "pesoano",      # ponderador
  income = "y_pc_d"         # variable de ingresos
)
```

---
# Quintiles de ingreso

- Los quintiles de ingreso se obtienen al ordenar la población, por ejemplo, en un país o región determinados, según la variable de ingresos considerada, de `r text_spec2("menor a mayor")` y luego se divide esa población en `r text_spec2("cinco partes iguales")`. 

- El `r text_spec2("20% de menores ingresos representa al primer quintil")`, el siguiente 20% representa el segundo quintil y así sucesivamente, hasta el 20% de mayores ingresos que representa el quinto quintil. 


---
# Quintiles de ingreso

En este caso generamos la variable quintil usando el ingreso per cápita corriente. La variable de ingreso va a cambiar según que queramos estimar. 


```{r eval=FALSE}
ech19 <- income_quantiles(ech19,
                          quantile = 5,
                          income = "y_pc")

```

Estimamos el promedio del ingreso per cápita a precios corrientes según quintiles de ingreso

```{r eval = FALSE}
get_estimation_mean(ech19,
                    variable = "y_pc",
                    by.x = "quintil",
                    level = "i")
```


Comparamos con el [OS](http://observatoriosocial.mides.gub.uy/New_Pivot/cubos/Promedio_de_ingresos_per_capita_a_precios_corrientes_segun_quintiles_de_ingreso_Total_pais_i13659.php)


---
class: inverse, center, middle
# ech::get_estimation_gini()

---
# Índice de Gini

- El índice de Gini es una `r text_spec2("medida de distribución del ingreso")`.

- `r text_spec2("Varía entre cero y uno")`, indicando mayor nivel de desigualdad cuanto más cercano a uno se encuentre.

- El INE para calcular el ingreso a utilizar en el Índice de Gini, deflacta los ingresos usando como año base 2005 y como mes base enero. Utiliza como índice el IPC a nivel regional.

- Para el cálculo de los intervalos de confianza se utiliza la técnica bootstrap, que implica hacer r sub-muestras de la muestra original.

---
# Estimar el Índice de Gini

El paquete ech prové una función específica para la estimación del IG

```{r eval=FALSE}
get_estimation_gini(
  data = ech::toy_ech_2018, # microdatos de la ECH
  variable = NULL,          # variable de ingresos a utilizar
  by = NULL,                # variable de cruce
  level = NULL,             # nivel de personas u hogares
  ids = NULL,               # upms
  numero = "numero",        # identificador del hogar
  estrato = NULL,           # estratos
  pesoano = "pesoano",      # ponderador
  bootstrap = FALSE,        # lógica para el bootstrap
  r = NULL                  # cantidad de sub-muestras
)
```

---
# Índice de Gini

Genero la variable ingreso deflactada por el IPC regional a enero de 2005.

```{r eval = FALSE}
ech19 <- income_constant_prices(ech19,
                                base_month = 1,
                                base_year = 2005,
                                index = "IPC",
                                level = "R")
```
---
# Índice de Gini

- Estimo el Índice de Gini a nivel de personas, usando 300 sub-muestras para el bootstrap.

- Uso el ingreso sin valor locativo per cápita deflactado a enero 2005 con IPC regional.

```{r eval = FALSE}
get_estimation_gini(ech19,
                    variable = "y_wrv_pc_d_r",
                    level = "i",
                    r = 300,
                    bootstrap = TRUE,
                    pesoano = "pesoano",
                    ids = "upm",
                    estrato = "estrato")
```

Comparo con [OTU](https://otu.opp.gub.uy/?q=listados/listados_datos_formato&id=2740&cant=0&fecha=2019-01-01)